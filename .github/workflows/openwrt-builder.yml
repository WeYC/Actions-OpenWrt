name: Build ImmortalWrt R6220 Full

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build'
        required: true
        default: 'v24.10.4'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TAG: ${{ github.event.inputs.tag }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential libncurses5-dev gawk git subversion python3 python3-distutils \
          libssl-dev zlib1g-dev ccache unzip time rsync wget curl

    - name: Clone ImmortalWrt
      run: |
        git clone --branch $TAG --depth 1 https://github.com/immortalwrt/immortalwrt.git immortalwrt

    - name: Modify DTS for R6220 overlay
      run: |
        cd immortalwrt/target/linux/ramips/dts
        # 扩大 rootfs/overlay 卷，把 reserved 并入
        sed -i '/partition@500000 {/,/};/ s/<0x500000 0x01c00000>/<0x500000 0x05800000>/' mt7621_netgear_r6220.dts
        sed -i '/partition@2100000 {/,/};/d' mt7621_netgear_r6220.dts
        cd ../../../..

    - name: Update feeds
      run: |
        cd immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Set default config for R6220 with packages
      run: |
        cd immortalwrt
        # 基础配置
        make defconfig
        # 选择 R6220 target
        echo "CONFIG_TARGET_ramips=y" >> .config
        echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
        echo "CONFIG_TARGET_ramips_mt7621_DEVICE_netgear_r6220=y" >> .config
        # 默认软件包：UPnP + 汉化
        echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-upnp-zh-cn=y" >> .config
        # 更新配置
        make defconfig

    - name: Compile firmware
      run: |
        cd immortalwrt
        make -j$(nproc) V=s

    - name: Prepare artifacts
      run: |
        cd immortalwrt/bin/targets/ramips/mt7621
        mkdir -p release
        cp -r * release/

    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG }}
        name: "ImmortalWrt R6220 ${{ env.TAG }}"
        body: "Automated build of ImmortalWrt R6220 ${{ env.TAG }} with overlay expanded and UPnP/Chinese packages"
      env:
        GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}

    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      with:
        files: immortalwrt/bin/targets/ramips/mt7621/release/**/*-r6220*.bin
      env:
        GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
