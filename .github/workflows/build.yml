name: Build ImmortalWrt R6220 Full

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build'
        required: true
        default: 'v24.10.4'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TAG: ${{ github.event.inputs.tag }}

    steps:
    # 1ï¸âƒ£ Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    # 2ï¸âƒ£ å®‰è£…å®˜æ–¹ ImmortalWrt æ„å»ºç¯å¢ƒï¼ˆè§£å†³ python3-distutils é—®é¢˜ï¼‰
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
        build-essential libncurses5-dev gawk git subversion \
        python3 python3-venv python3-pip python3-setuptools python3-distutils-extra \
        libssl-dev zlib1g-dev ccache unzip time rsync wget curl


    # 3ï¸âƒ£ Clone ImmortalWrt æºç æŒ‡å®š tag
    - name: Clone ImmortalWrt
      run: |
        git clone --branch $TAG --depth 1 https://github.com/immortalwrt/immortalwrt.git immortalwrt

    # 4ï¸âƒ£ ä¿®æ”¹ R6220 DTS æ‰©å¤§ overlay
    - name: Modify DTS for R6220 overlay
      run: |
        cd immortalwrt/target/linux/ramips/dts
        # æ‰©å¤§ rootfs/overlayï¼ŒæŠŠ reserved å¹¶å…¥
        sed -i '/partition@500000 {/,/};/ s/<0x500000 0x01c00000>/<0x500000 0x05800000>/' mt7621_netgear_r6220.dts
        sed -i '/partition@2100000 {/,/};/d' mt7621_netgear_r6220.dts
        cd ../../../..

    # 5ï¸âƒ£ æ›´æ–° feeds
    - name: Update feeds
      run: |
        cd immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 6ï¸âƒ£ è®¾ç½®é»˜è®¤ target R6220 + é»˜è®¤è½¯ä»¶åŒ…
    - name: Set default config for R6220 with packages
      run: |
        cd immortalwrt
        make defconfig
        # è®¾ç½® R6220 target
        echo "CONFIG_TARGET_ramips=y" >> .config
        echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
        echo "CONFIG_TARGET_ramips_mt7621_DEVICE_netgear_r6220=y" >> .config
        # é»˜è®¤è½¯ä»¶åŒ…ï¼šUPnP + ä¸­æ–‡åŒ…
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-upnp-zh-cn=y" >> .config
        # æ›´æ–°é…ç½®
        make defconfig

    # 7ï¸âƒ£ ç¼–è¯‘å›ºä»¶
    - name: Compile firmware
      run: |
        cd immortalwrt
        make -j$(nproc) V=s

    # 8ï¸âƒ£ å‡†å¤‡ Release ç›®å½•
    - name: Prepare artifacts
      run: |
        cd immortalwrt/bin/targets/ramips/mt7621
        mkdir -p release
        cp -r * release/

    # 9ï¸âƒ£ åˆ›å»º GitHub Release
    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG }}
        name: "ImmortalWrt R6220 ${{ env.TAG }}"
        body: "Automated build of ImmortalWrt R6220 ${{ env.TAG }} with overlay expanded and UPnP/Chinese packages"
      env:
        GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}

    # ğŸ”Ÿ ä¸Šä¼ å›ºä»¶åˆ° Release
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      with:
        files: immortalwrt/bin/targets/ramips/mt7621/release/**/*-r6220*.bin
      env:
        GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
