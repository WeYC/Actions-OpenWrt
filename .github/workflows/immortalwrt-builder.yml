name: Build ImmortalWrt R6220 with Docker

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build'
        required: true
        default: 'v24.10.4'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TAG: ${{ github.event.inputs.tag }}

    steps:
    # 1️⃣ Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    # 2️⃣ Pull official ImmortalWrt Docker image
    - name: Pull Docker build environment
      run: |
        docker pull immortalwrt/build-env:latest

    # 3️⃣ Build inside Docker
    - name: Build firmware in Docker
      run: |
        docker run --rm -v $PWD:/build -w /build immortalwrt/build-env:latest /bin/bash -c "
          set -e
          # Clone ImmortalWrt
          git clone --branch $TAG --depth 1 https://github.com/immortalwrt/immortalwrt.git immortalwrt
          cd immortalwrt

          # 修改 R6220 DTS 扩展 overlay
          cd target/linux/ramips/dts
          sed -i '/partition@500000 {/,/};/ s/<0x500000 0x01c00000>/<0x500000 0x05800000>/' mt7621_netgear_r6220.dts
          sed -i '/partition@2100000 {/,/};/d' mt7621_netgear_r6220.dts
          cd ../../../..

          # 更新 feeds
          cd immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # 设置默认 target R6220 + 默认软件包
          make defconfig
          echo 'CONFIG_TARGET_ramips=y' >> .config
          echo 'CONFIG_TARGET_ramips_mt7621=y' >> .config
          echo 'CONFIG_TARGET_ramips_mt7621_DEVICE_netgear_r6220=y' >> .config
          echo 'CONFIG_PACKAGE_luci-app-upnp=y' >> .config
          echo 'CONFIG_PACKAGE_luci-i18n-base-zh-cn=y' >> .config
          echo 'CONFIG_PACKAGE_luci-i18n-upnp-zh-cn=y' >> .config
          make defconfig

          # 编译固件
          make -j$(nproc) V=s
        "

    # 4️⃣ 准备 Release 目录
    - name: Prepare artifacts
      run: |
        mkdir -p release
        cp -r immortalwrt/bin/targets/ramips/mt7621/*-r6220*.bin release/

    # 5️⃣ 创建 GitHub Release
    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG }}
        name: "ImmortalWrt R6220 ${{ env.TAG }}"
        body: "Automated build of ImmortalWrt R6220 ${{ env.TAG }} with overlay expanded and UPnP/Chinese packages"
      env:
        GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}

    # 6️⃣ 上传 Release 固件
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      with:
        files: release/*.bin
      env:
        GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
